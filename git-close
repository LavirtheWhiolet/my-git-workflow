#!/usr/bin/env ruby
require 'shellwords'

def sh(command)
  system command
  exit $?.exitstatus if $?.exitstatus != 0
end

class String
  
  def esc
    Shellwords.shellescape(self)
  end
  
end

class Array
  
  def esc
    self.map(&:esc).join(" ")
  end
  
end

# Parse args.
if ARGV[0] == "-h" or ARGV[0] == "--help"
  puts HELP
  exit
end
program = File.basename $0
current_branch = `git symbolic-ref --short HEAD`
dest_branch = ARGV.pop
merge_opts = ARGV
# Close the branch!
def hyphens_escape_before(last_arg)
  if last_arg.start_with? "-" then "--" else "" end
end
current_branch_remote = `git config --get branch.#{current_branch.esc}.remote`
current_branch_remote = nil if current_branch_remote == ""
sh "git checkout #{hyphens_escape_before(dest_branch)} #{dest_branch.esc}"
sh "git merge #{ARGV}"
sh "git branch -D #{current_branch.esc}"
if current_branch_remote then
  sh "git push #{current_branch_remote} :#{current_branch.esc}"
end
