#!/bin/bash

# Parse arguments.
this=`basename "$0"`
current_branch=`git symbolic-ref --short HEAD`
dest_branch=""
squash_arg=""
message_arg=""
while [ -n "$1" ]; do
  case "$1" in
    -m|--message)
      if [ -z "$2" ]; then
        echo "$this: -m or --message require the message"
        exit 1
      fi
      message_escaped=`printf "%q" "$2"`
      message_arg="-m $message_escaped"
      echo $message_arg
      exit
      shift
      ;;
    -s|--squash)
      squash_arg="--squash"
      ;;
    -?*)
      echo "$this: unknown option: $1"
      exit 1
      ;;
    *)
      dest_branch="$1"
      break
      ;;
  esac
  shift
done
# Close!
current_branch_remote=`git config --get branch."$current_branch".remote`
git checkout "$dest_branch" && \
git merge $message_arg $squash_arg "$current_branch" && \
git branch -D "$current_branch" && \
{
  if [ -n "$current_branch_remote" ]; then
    git push "$current_branch_remote" ":$current_branch"
  else
    true
  fi
}
